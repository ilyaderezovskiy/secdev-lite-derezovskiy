# S05 - Матрица вариантов (Option Matrix)

---

## 0) Контекст риска (из S04)

* **Risk-ID:** R-02  
* **Threat:** I (Information Disclosure)  
* **DFD element/edge:** Node: Service → Logs (все backend-сервисы)  
* **NFR link (ID):** NFR-007 (Privacy/PII)  
* **L×I (1-5):** L=4, I=4, Score=16  
* **Ограничения/предпосылки:**  
  - Логи хранятся в централизованной системе (ELK).  
  - JSON-структурированные логи, correlation_id.  
  - Продукт обрабатывает PII (email, телефон).      

---

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает).
* **Blast radius reduction (↑):** насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** сложность внедрения (код/конфиг/политики).
* **Time-to-mitigate (↓):** сколько времени до эффекта (в днях/спринтах).
* **Dependencies (↓):** внешние/внутренние зависимости (команды, провайдеры, миграции).

> Оценка **1-5**: 1 - минимально / 5 - максимально. Для «стоимостных» критериев **меньше - лучше**.

**Итоговые метрики (подсказка):**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**  *(чем больше, тем привлекательнее)*

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы) | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| **A** | Маскирование PII на уровне logger middleware | 5 | 4 | 3 | 2 | 2 | **9** | **7** | **+2** | Сохраняется корреляция, минимальный blast radius, быстрый rollout |
| **B** | Полный запрет логирования DTO (white-list полей) | 4 | 5 | 4 | 3 | 3 | **9** | **10** | **−1** | Безопасно, но усложняет диагностику, выше Cost |
| **C** | Post-processing scrubber в ELK | 3 | 3 | 2 | 3 | 4 | **6** | **9** | **−3** | PII успевает попасть в pipeline до очистки, меньше Security impact |

> **Как считать:**
> `Benefit = Security impact + Blast radius reduction`
> `Cost = Complexity + Time-to-mitigate + Dependencies`
> `Net = Benefit − Cost`

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** вариант A полностью соответствует GDPR/152-ФЗ.  
* **Maintainability:** централизованные фильтры легко обновлять при изменении DTO.  
* **Team fit:** команда уже использует общий логгер.  
* **Observability:** сохраняются correlation_id и ключевые поля запроса/ответа.  
* **Rollback safety:** безопасное включение/выключение фильтров через конфиг.  

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** **A — PII Masking Logger Middleware**  
* **Почему:** оптимальное сочетание Security impact и Cost. Полностью предотвращает логирование необработанных PII, при этом сохраняется observability и легко откатывается при необходимости.  
* **ADR candidate (название):** `PII Masking Logger Middleware`  
* **Связки:** Risk-ID R-03, NFR-ID NFR-007, DFD: Node Service→Logs  

**Следующие шаги (что меняем):**  
1. Добавить middleware-фильтр для маскирования PII в логах (email, phone, address).  
2. Настроить allowlist для логируемых полей (ключи запроса/ответа, correlation_id).  
3. Настроить retention policy для raw PII ≤30 дней.  
4. Добавить unit-тесты и e2e-тесты для проверки маскирования.  
5. Обновить документацию и internal security guidelines.  

---

## 6) Самопроверка

* [+] Риск и контекст из S04 указаны (Risk-ID, DFD, NFR-ID, L×I).
* [+] Сравнили **минимум 2 альтернативы**.
* [+] Заполнены все критерии 1-5; посчитаны Benefit/Cost/Net.
* [+] Описаны тай-брейкеры (если Net равен).
* [+] Принято решение и зафиксирован **ADR candidate**.
* [+] Готовы перенести решение в **`S05_ADR_<slug>.md`** (шаблон ADR).

---
