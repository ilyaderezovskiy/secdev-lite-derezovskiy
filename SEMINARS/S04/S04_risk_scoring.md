# S04 - Приоритизация рисков L×I (risk scoring template)

Этот файл агрегирует риски из `S04_stride_matrix.md`:

* **объединяем дубликаты**,
* выставляем **L** и **I** (1-5),
* считаем **Score = L×I**,
* фиксируем **Top-5** и рабочие названия будущих **ADR** (решений для S05).

---

## Как работать с шаблоном

1. Просмотрите `S04_stride_matrix.md` и **склейте похожие угрозы** в единые формулировки (consolidation).
2. Для каждой записи:

   * кратко опишите **суть риска** (Consolidated Description),
   * укажите **Threat** (S/T/R/I/D/E), **NFR link (ID)** (или `need NFR`),
   * выставьте **L** и **I** (по шкале ниже) и кратко обоснуйте каждую оценку,
   * посчитайте **Score = L×I**,
   * пометьте **Decision (Top-5?)** и впишите черновой **ADR candidate**.

---

## Шкала L×I (1-5)

**Likelihood (вероятность):**
1 - маловероятно (редкая поверхность, сложная эксплуатация, хорошая детекция)
2 - низкая
3 - средняя
4 - высокая
5 - очень высокая (публичная поверхность, типовая уязвимость, слабая детекция)

**Impact (ущерб):**
1 - низкий (локальный эффект, без PII/денег/доступности)
2 - умеренный
3 - значимый (PII/деньги одного клиента/подсистемы)
4 - высокий (существенный ущерб/простой)
5 - критичный (массовая утечка, компрометация прав, длительный простой)

**Score = L × I** → сортируем по убыванию → отмечаем **Top-5**.

---

## Тай-брейкеры при равенстве Score

* **Blast radius** - масштаб затрагиваемых пользователей/тенантов/данных.
* **Detectability** - насколько быстро обнаружим (логи/алерты/аудит) или это скрытно.
* **Compliance** - приватность/платёжные/регуляторные последствия.
* **Time-to-Mitigate** - насколько быстро/безопасно закрывается.
* **Dependency risk** - зависит от внешних провайдеров/узких мест.

---

## Таблица приоритизации (заполняйте)

| Risk ID | Source (DFD/Row) | Consolidated Description | Threat (S/T/R/I/D/E) | NFR link (ID) | L (1-5) | Rationale-L | I (1-5) | Rationale-I | **Score (=L×I)** | Decision (Top-5?) | ADR candidate |
| ------- | ---------------- | ------------------------ | -------------------- | ------------- | ------: | ----------- | ------: | ----------- | ---------------: | ----------------- | ------------- |
| **R-01** | Internet → API Gateway | Кража или повторное использование JWT-токена (replay/stolen token) из-за компрометации клиента или слабой проверки TTL. | **S** | need NFR (→ NFR-011) | 4 | Публичный интерфейс, частая цель атак; возможен фишинг или XSS. | 5 | Компрометация учётных записей и доступ к PII. | **20** | **Top-1** | `JWT TTL+Refresh` |
| **R-02** | Logs / Services / API | Утечка PII (email, phone, user_id) в логах или ошибках, особенно при исключениях. | **I** | **NFR-007** | 4 | Частая ошибка логирования, возможна даже при debug-уровне. | 4 | Нарушение GDPR/конфиденциальности, возможны санкции. | **16** | **Top-2** | `PII Masking` |
| **R-03** | API Gateway ↔ Services | Отсутствие или неправильная авторизация — доступ к чужим профилям (horizontal privilege escalation). | **E** | **NFR-009** | 3 | Сценарий возможен при ошибке в middleware. | 5 | Нарушение приватности, доступ к чужим данным. | **15** | **Top-3** | `RBAC isolation` |
| **R-04** | Services → DB | SQL-инъекции или некорректная валидация входных данных, приводящая к порче данных. | **T** | **NFR-008** | 3 | Средний риск при ошибках в ORM или ручных запросах. | 4 | Нарушение целостности БД, утечки данных. | **12** | **Top-4** | `Parametrized Queries + Validation` |
| **R-05** | API ↔ External Search API | Долгие или зависшие внешние запросы приводят к истощению потоков (DoS). | **D** | **NFR-005** | 3 | Внешние зависимости, нестабильный API. | 4 | Замедление работы сервиса, деградация поиска. | **12** | **Top-5** | `Circuit Breaker + Timeout` |
| **R-06** | API Gateway | Отсутствие трассировки корреляции запросов — невозможно расследовать инциденты. | **R** | **NFR-006**, **NFR-010** | 2 | Возможен при ошибках логирования. | 2 | Усложняет аудит, но не влияет напрямую на безопасность. | **4** | — | `Correlation-ID logging` |
| **R-07** | Database | Отсутствие аудита DML-операций (insert/update/delete). | **R** | need NFR (→ NFR-013) | 2 | Проблема организационного уровня. | 3 | Потеря трассируемости изменений. | **6** | — | `DB Audit Trail` |
| **R-08** | API Gateway | Перегрузка запросами без лимитов, вызывающая отказ в обслуживании. | **D** | **NFR-004** | 3 | Публичная поверхность, возможен спам/скриптинг. | 3 | Замедление отклика или временная недоступность. | **9** | — | `Rate Limiting` |
| **R-09** | External API Response | Ответ от внешнего API содержит неожиданные данные или PII. | **I** | need NFR (→ NFR-012) | 2 | Реже встречается, но возможен при слабой валидации схем. | 3 | Потенциальная утечка чужих данных. | **6** | — | `External Response Sanitization` |
| **R-10** | Search Service / Load | Высокая нагрузка на индекс замедляет SLA. | **D** | **NFR-003** | 3 | Вероятно при пиках нагрузки. | 2 | Влияет на UX, но не на безопасность. | **6** | — | `Autoscaling + SLO monitor` |

> **Подсказки по полям:**
> **Risk ID** - локальный идентификатор (например, `R-01`).
> **Source (DFD/Row)** - откуда взят риск (узел/ребро и строка из STRIDE-матрицы).
> **NFR link (ID)** - ID из реестра S03 (если «дыра» - `need NFR`).
> **ADR candidate** - короткое имя будущего решения (напр., `JWT TTL+Refresh`, `PII Masking`, `CB for External API`).

---

## Сводка Top-5 (итог блока)

После сортировки по **Score** выпишите итоговый список для S05:

| Rank | Risk ID | Risk Summary | L | I | **L×I** | ADR candidate | Why critical |
|------|----------|---------------|---|---|---------|----------------|---------------|
| **Top-1** | R-01 | Кража/повторное использование JWT-токена | **4** | **5** | **20** | `JWT TTL+Refresh` | Высокая вероятность из-за публичного API и частых атак на токены; ущерб критичный — полный доступ к учётке и PII. |
| **Top-2** | R-02 | Утечка PII в логах/ошибках | **4** | **4** | **16** | `PII Masking` | Частая ошибка при логировании; значительный ущерб (нарушение конфиденциальности, GDPR). |
| **Top-3** | R-03 | Ошибки в авторизации (RBAC) | **3** | **5** | **15** | `RBAC isolation` | Средняя вероятность при ошибках middleware; ущерб максимальный — доступ к чужим данным. |
| **Top-4** | R-04 | SQL-инъекция/ошибки валидации | **3** | **4** | **12** | `Parametrized Queries + Validation` | Реже при использовании ORM, но последствия серьёзные — компрометация или порча данных. |
| **Top-5** | R-05 | Перегрузка/зависание внешнего API | **3** | **4** | **12** | `Circuit Breaker + Timeout` | Возможна при сбое внешнего провайдера; высокий ущерб — деградация сервиса, DoS. |

---

## Что получаем по итогам заполнения

* Очистили дубли и получили **сжатый список рисков**.
* У каждого риска есть **L×I (1-5)** с обоснованием и **Score**.
* Отмечен **Top-5** и намечены **ADR candidate** - готовность к S05.
